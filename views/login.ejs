<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Login - Respect Ledger</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
    body { font-family: 'Inter', sans-serif; }
  </style>
</head>
<body class="bg-slate-900 text-white min-h-screen">
  <div class="min-h-screen flex items-center justify-center p-4">
    <div class="w-full max-w-md">
      <!-- Logo & Title -->
      <div class="text-center mb-8">
        <div class="text-6xl mb-4">üèÜ</div>
        <h1 class="text-3xl font-bold text-white mb-2">Respect Ledger</h1>
        <p class="text-slate-400">RPG Edition</p>
      </div>

      <!-- Login Card -->
      <div class="bg-slate-800 rounded-2xl p-6 shadow-2xl border border-slate-700">
        <h2 class="text-xl font-semibold text-white mb-6 text-center">Select Your Character</h2>
        
        <form id="login-form" action="/login" method="POST" class="space-y-6">
          <!-- User Selection -->
          <div class="grid grid-cols-2 gap-3">
            <% users.forEach((u, i) => { %>
              <label class="relative">
                <input type="radio" name="user_id" value="<%= u.id %>" class="peer sr-only user-radio" <%= i === 0 ? 'checked' : '' %> required>
                <div class="bg-slate-700 border-2 border-slate-600 rounded-xl p-4 cursor-pointer transition-all
                            peer-checked:border-yellow-500 peer-checked:bg-slate-600 hover:bg-slate-600">
                  <div class="text-4xl text-center mb-2"><%= u.avatar_emoji %></div>
                  <div class="text-center font-medium text-white"><%= u.name %></div>
                </div>
              </label>
            <% }); %>
          </div>

          <!-- PIN Input -->
          <div>
            <label class="block text-sm font-medium text-slate-300 mb-2">Enter PIN</label>
            <input 
              id="pin-input"
              type="password" 
              name="pin_code" 
              required
              maxlength="20"
              placeholder="Enter PIN"
              class="w-full px-4 py-3 bg-slate-700 border border-slate-600 rounded-xl text-white text-center text-lg
                     focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:border-transparent
                     placeholder:text-slate-500"
            >
          </div>

          <!-- Remember Me Checkbox -->
          <div class="flex items-center gap-2">
            <input 
              type="checkbox" 
              id="remember-me" 
              name="remember_me"
              class="w-4 h-4 text-yellow-500 bg-slate-700 border-slate-600 rounded focus:ring-yellow-500 focus:ring-2"
            >
            <label for="remember-me" class="text-sm text-slate-300 cursor-pointer">
              Remember me on this device
            </label>
          </div>

          <!-- Submit Button -->
          <button 
            type="submit"
            class="w-full py-4 bg-gradient-to-r from-yellow-500 to-yellow-600 text-slate-900 font-bold rounded-xl
                   hover:from-yellow-400 hover:to-yellow-500 transition-all transform hover:scale-[1.02]
                   focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:ring-offset-2 focus:ring-offset-slate-800"
          >
            Enter the Realm
          </button>
        </form>
      </div>

      <!-- Footer -->
      <p class="text-center text-slate-500 text-sm mt-6">
        Track respect. Complete quests. Earn rewards.
      </p>
    </div>
  </div>

  <% if (typeof flash !== 'undefined' && flash) { %>
  <div id="flash-message" class="fixed top-4 right-4 z-50 max-w-sm animate-pulse">
    <div class="<%= flash.type === 'error' ? 'bg-red-500' : 'bg-green-500' %> text-white px-6 py-4 rounded-lg shadow-xl flex items-center gap-3">
      <span class="font-medium"><%= flash.message %></span>
    </div>
  </div>
  <script>
    setTimeout(() => {
      const flash = document.getElementById('flash-message');
      if (flash) {
        flash.style.transition = 'opacity 0.5s';
        flash.style.opacity = '0';
        setTimeout(() => flash.remove(), 500);
      }
    }, 3000);
  </script>
  <% } %>

  <script>
    // Local Storage Keys
    const STORAGE_KEY = 'respectLedger_rememberedUser';

    // Helper functions for encoding/decoding (basic obfuscation)
    function encodePin(pin) {
      return btoa(pin); // Base64 encoding for basic obfuscation
    }

    function decodePin(encodedPin) {
      try {
        return atob(encodedPin);
      } catch (e) {
        return null;
      }
    }

    // Save credentials to local storage
    function saveCredentials(userId, pinCode) {
      const rememberedUser = {
        user_id: userId,
        pin_code: encodePin(pinCode),
        timestamp: Date.now()
      };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(rememberedUser));
    }

    // Get saved credentials from local storage
    function getSavedCredentials() {
      try {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (!saved) return null;
        
        const rememberedUser = JSON.parse(saved);
        const decodedPin = decodePin(rememberedUser.pin_code);
        
        if (!decodedPin) return null;
        
        return {
          user_id: rememberedUser.user_id,
          pin_code: decodedPin
        };
      } catch (e) {
        console.error('Error reading saved credentials:', e);
        return null;
      }
    }

    // Clear saved credentials
    function clearSavedCredentials() {
      localStorage.removeItem(STORAGE_KEY);
    }

    // Auto-fill form with saved credentials
    function autoFillForm(credentials) {
      if (!credentials) return false;

      // Select the user radio button
      const userRadio = document.querySelector(`input[type="radio"][name="user_id"][value="${credentials.user_id}"]`);
      if (userRadio) {
        userRadio.checked = true;
        // Trigger change event to update UI
        userRadio.dispatchEvent(new Event('change', { bubbles: true }));
      }

      // Fill PIN
      const pinInput = document.getElementById('pin-input');
      if (pinInput) {
        pinInput.value = credentials.pin_code;
      }

      return true;
    }

    // Auto-login with saved credentials
    function performAutoLogin() {
      const credentials = getSavedCredentials();
      if (!credentials) return false;

      // Find user radio button
      const userRadio = document.querySelector(`input[type="radio"][name="user_id"][value="${credentials.user_id}"]`);
      if (!userRadio) return false;

      // Auto-fill form
      if (autoFillForm(credentials)) {
        // Small delay to ensure form is filled, then auto-submit
        setTimeout(() => {
          document.getElementById('login-form').submit();
        }, 200);
        return true;
      }
      return false;
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
      // Check if user just logged out - clear saved credentials
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.get('logout') === '1') {
        clearSavedCredentials();
        // Clean up URL
        window.history.replaceState({}, document.title, window.location.pathname);
      }

      // Check for saved credentials and auto-login
      const credentials = getSavedCredentials();
      if (credentials) {
        // Automatically log in if saved credentials exist
        performAutoLogin();
        return; // Exit early since we're auto-logging in
      }

      // Handle form submission - save credentials if "Remember me" is checked
      const loginForm = document.getElementById('login-form');
      if (loginForm) {
        loginForm.addEventListener('submit', function(e) {
          const rememberMe = document.getElementById('remember-me').checked;
          const userId = document.querySelector('input[name="user_id"]:checked')?.value;
          const pinCode = document.getElementById('pin-input').value;

          if (rememberMe && userId && pinCode) {
            saveCredentials(userId, pinCode);
          } else if (!rememberMe) {
            // Clear saved credentials if user unchecks "Remember me"
            clearSavedCredentials();
          }
        });
      }
    });
  </script>
</body>
</html>
